<!doctype html><html><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><title>
        Webgraph from scratch: BVGraph (Draft)
    </title><link href=/corro.svg rel=icon type=image/png><link href=https://zom.wtf/fonts.css rel=stylesheet><link href=/path/to/folder/css/academicons.min.css rel=stylesheet><link href=https://zom.wtf/atom.xml rel=alternate title=zom.wtf type=application/atom+xml><link href=https://zom.wtf/theme/light.css rel=stylesheet><link href=https://zom.wtf/main.css media=screen rel=stylesheet><body><div class=content><header><div class=main><img id=title_icon src=/corro.svg><a href=https://zom.wtf>zom.wtf</a><div class=socials><a class=social href=https://twitter.com/zommiommy> <img alt=twitter src=/social_icons/twitter.svg> </a><a class=social href=https://github.com/zommiommy> <img alt=github src=/social_icons/github.svg> </a></div></div><nav><a href=/posts style=margin-left:.7em>/posts</a><a href=/about style=margin-left:.7em>/about</a><a href=/goodstuff style=margin-left:.7em>/good_stuff</a></nav></header><main><article><div class=title><div class=page-header>Webgraph from scratch: BVGraph (Draft)</div><div class=meta>Posted on <time>2023-09-25</time></div></div><h1>Table of Contents</h1><ul><li><a href=https://zom.wtf/posts/webgraph-bvgraph/#bvgraph>BVGraph</a> <ul><li><a href=https://zom.wtf/posts/webgraph-bvgraph/#example>Example</a><li><a href=https://zom.wtf/posts/webgraph-bvgraph/#compression-tradeoffs>Compression tradeoffs</a><li><a href=https://zom.wtf/posts/webgraph-bvgraph/#offsets-list>Offsets list</a><li><a href=https://zom.wtf/posts/webgraph-bvgraph/#benchmarks>Benchmarks</a><li><a href=https://zom.wtf/posts/webgraph-bvgraph/#how-to-choose-the-best-codes>How to choose the best codes?</a></ul><li><a href=https://zom.wtf/posts/webgraph-bvgraph/#computing-an-order>Computing an order</a> <ul><li><a href=https://zom.wtf/posts/webgraph-bvgraph/#bfs>BFS</a><li><a href=https://zom.wtf/posts/webgraph-bvgraph/#layered-labels-propagation>Layered Labels Propagation</a><li><a href=https://zom.wtf/posts/webgraph-bvgraph/#benchmarks-1>Benchmarks</a></ul><li><a href=https://zom.wtf/posts/webgraph-bvgraph/#references>References</a></ul><section class=body><p><em>This post assumes familiarity with the instantaneous codes we discussed in <a href=/posts/webgraph-codes>the previous post</a></em><h1 id=bvgraph>BVGraph</h1><p>BVGraph is a graph compression data-structure which exploits some common properties of real-world graphs. The basic idea is to use instantaneous codes to represent an adjacency list (a.k.a. CSR).<p>The BVGraph format has three core compression methods:<ul><li>A node can copy successors from a previous node<li>Intervals of nodes with consecutive ids are written as the tuple (start, len)<li>The remaning nodes are sorted and encoded as a sequence of gaps (differences between successive nodes).</ul><p>We can already notice that this compression depends from the node ids. Finding the optimal order is most likely NP Complete, so later in this post we will discuss some heuristic methods to find good orders.<h2 id=example>Example</h2><p>Let's start with a simple graph: <img alt src=/bvgraph_graph.svg><p>I've compressed it with the default codes, which are:<table><thead><tr><th>Value<th>Code<tbody><tr><td class="tag tag_degree">Outdegree<td>Gamma<tr><td class="tag tag_reference_offset">ReferenceOffset<td>Unary<tr><td class="tag tag_blocks_count">BlockCount<td>Gamma<tr><td class="tag tag_blocks">Blocks<td>Gamma<tr><td class="tag tag_nintervals">IntervalCount<td>Gamma<tr><td class="tag tag_interval_start">IntervalStart<td>Gamma<tr><td class="tag tag_interval_len">IntervalLen<td>Gamma<tr><td class="tag tag_first_residual">FirstResidual<td>Zeta(3)<tr><td class="tag tag_residual_gap">ResidualGap<td>Zeta(3)</table><p>This graph has 9 nodes and 12 arcs, once compressed with BVGraph we obtain two files, the <code>test.properties</code>:<pre class=language-ini data-lang=ini style=background:#0f1419;color:#bfbab0><code class=language-ini data-lang=ini><span style=font-style:italic;color:#5c6773>#BVGraph properties
</span><span style=color:#f29718>version</span><span style=color:#f29668>=</span><span style=color:#f29718>0
</span><span style=color:#f29718>graphclass</span><span style=color:#f29668>=</span><span>it</span><span style=color:#f29668>.</span><span>unimi</span><span style=color:#f29668>.</span><span>dsi</span><span style=color:#f29668>.</span><span>webgraph</span><span style=color:#f29668>.</span><span>BVGraph
</span><span style=color:#f29718>nodes</span><span style=color:#f29668>=</span><span style=color:#f29718>9
</span><span style=color:#f29718>arcs</span><span style=color:#f29668>=</span><span style=color:#f29718>12
</span><span style=color:#f29718>minintervallength</span><span style=color:#f29668>=</span><span style=color:#f29718>3
</span><span style=color:#f29718>maxrefcount</span><span style=color:#f29668>=</span><span style=color:#f29718>3
</span><span style=color:#f29718>windowsize</span><span style=color:#f29668>=</span><span style=color:#f29718>7
</span><span style=color:#f29718>zetak</span><span style=color:#f29668>=</span><span style=color:#f29718>3
</span><span style=color:#f29718>compressionflags</span><span style=color:#f29668>=
</span></code></pre><p>and the <code>test.graph</code> file which contains the compressed graph as the following bytes:<pre style=background:#0f1419;color:#bfbab0><code><span>7d c5 ea 64 a7 27 72 97 a9 e0
</span></code></pre><p>which is equivalent to the bits:<pre style=background:#0f1419;color:#bfbab0><code><span>01111101 11000101 11101010 01100100 10100111 00100111 01110010 10010111 10101001 11100000
</span></code></pre><p>and is equivalent to the bitstream:<pre style=background:#0f1419;color:#bfbab0><code><span>011111011100010111101010011001001010011100100111011100101001011110101001111
</span></code></pre><p>With syntax highlighting:<div><span class="tag tag_degree">011</span><span class="tag tag_reference_offset">1</span><span class="tag tag_nintervals">1</span><span class="tag tag_first_residual">1011</span><span class="tag tag_residual_gap">100</span><span>|</span><span class="tag tag_degree">010</span><span class="tag tag_reference_offset">1</span><span class="tag tag_nintervals">1</span><span class="tag tag_first_residual">1101</span><span>|</span><span class="tag tag_degree">010</span><span class="tag tag_reference_offset">01</span><span class="tag tag_blocks_count">1</span><span>|</span><span class="tag tag_degree">00100</span><span class="tag tag_reference_offset">1</span><span class="tag tag_nintervals">010</span><span class="tag tag_interval_start">011</span><span class="tag tag_interval_len">1</span><span>|</span><span class="tag tag_degree">00100</span><span class="tag tag_reference_offset">1</span><span class="tag tag_nintervals">1</span><span class="tag tag_first_residual">1011</span><span class="tag tag_residual_gap">100</span><span class="tag tag_residual_gap">1010</span><span>|</span><span class="tag tag_degree">010</span><span class="tag tag_reference_offset">1</span><span class="tag tag_nintervals">1</span><span class="tag tag_first_residual">1101</span><span>|</span><span class="tag tag_degree">010</span><span class="tag tag_reference_offset">01</span><span class="tag tag_blocks_count">1</span><span>|</span><span class="tag tag_degree">1</span><span>|</span><span class="tag tag_degree">1</span></div> Reading the codes we obtain: <div><span class="tag tag_degree">2</span><span class="tag tag_reference_offset">0</span><span class="tag tag_nintervals">0</span><span class="tag tag_first_residual">2</span><span class="tag tag_residual_gap">0</span><span>|</span><span class="tag tag_degree">1</span><span class="tag tag_reference_offset">0</span><span class="tag tag_nintervals">0</span><span class="tag tag_first_residual">4</span><span>|</span><span class="tag tag_degree">1</span><span class="tag tag_reference_offset">1</span><span class="tag tag_blocks_count">0</span><span>|</span><span class="tag tag_degree">3</span><span class="tag tag_reference_offset">0</span><span class="tag tag_nintervals">1</span><span class="tag tag_interval_start">2</span><span class="tag tag_interval_len">0</span><span>|</span><span class="tag tag_degree">3</span><span class="tag tag_reference_offset">0</span><span class="tag tag_nintervals">0</span><span class="tag tag_first_residual">2</span><span class="tag tag_residual_gap">0</span><span class="tag tag_residual_gap">1</span><span>|</span><span class="tag tag_degree">1</span><span class="tag tag_reference_offset">0</span><span class="tag tag_nintervals">0</span><span class="tag tag_first_residual">4</span><span>|</span><span class="tag tag_degree">1</span><span class="tag tag_reference_offset">1</span><span class="tag tag_blocks_count">0</span><span>|</span><span class="tag tag_degree">0</span><span>|</span><span class="tag tag_degree">0</span></div><p>Finally, we can start iterating on the graph:<p><strong>Node 0</strong><div>Bits: <span class="tag tag_degree">011</span><span class="tag tag_reference_offset">1</span><span class="tag tag_nintervals">1</span><span class="tag tag_first_residual">1011</span><span class="tag tag_residual_gap">100</span><br> Outdegree: <span class="tag tag_degree">2</span><br> Reference Offset: <span class="tag tag_reference_offset">0</span><br> Number of Intervals: <span class="tag tag_nintervals">0</span><br> First Residual: <span class="tag tag_first_residual">2</span><br> Residual Gap: <span class="tag tag_residual_gap">0</span><br></div><p>This node has outdegree 2, doesn't copy any node and has no intervals, so it has only residuals.<p>The first residual is a signed offset from the current node, so the first successor is \(0 + \phi^{-1}(2) = 0 + 1 = 1\).<p>The second residual is the gap from the previous residual, minus one, so: \(1 + (0 + 1) = 2\).<p>So the successors of node 0 are \(\{1, 2\}\).<p><strong>Node 1</strong><div>Bits: <span class="tag tag_degree">010</span><span class="tag tag_reference_offset">1</span><span class="tag tag_nintervals">1</span><span class="tag tag_first_residual">1101</span><br> Outdegree: <span class="tag tag_degree">1</span><br> Reference Offset: <span class="tag tag_reference_offset">0</span><br> Number of Intervals: <span class="tag tag_nintervals">0</span><br> First Residual: <span class="tag tag_first_residual">4</span><br></div><p>This node has outdegree 1, doesn't copy any node and has no intervals, so it has only residuals.<p>The first residual is a signed offset from the current node, so the first successor is \(0 + \phi^{-1}(4) = 1 + 2 = 3\).<p>So the successors of node 1 are \(\{3\}\).<h2 id=compression-tradeoffs>Compression tradeoffs</h2><p>Compression windows, Reference chain length<h2 id=offsets-list>Offsets list</h2><p>To have have random-access on a BVGraph bitstream we need to store the bitoffsets at which each node codes start, analogously to the offsets list of a CSR matrix.<p>While this could just be a vector of integers, we can notice that the offsets are a monotone non decreasing sequence of positive integers, thus they can be represented using Elias-Fano!<p>For a BVGraph bitstream of length (l) of a graph with (|V|) nodes, Elias-Fano stores the offsets using at most \(|V| (2 + \lfloor \log2 \frac{l}{|V|} \rfloor)\) bits while having \(O(1)\) access (select) if paired with an appropriate index.<p><a href=https://zom.wtf/posts/elias_fano_pt1><em>See my other post for more info on Elias-Fano</em></a><h2 id=benchmarks>Benchmarks</h2><h2 id=how-to-choose-the-best-codes>How to choose the best codes?</h2><p>Use universal codes, gamma is really fast so it's a good default choice. Otherwise we can "simulate" writing every piece with all the codes, this requires just a complete iteration over the nodes so it's feasible also on large graphs.<p>Webgraph-rs has an optimized binary utility for this.<p>In my practical application we don't save much memory, about 3 GB over a 126GB graph, but we found out that zeta3 and delta have similar compressions, so we use delta which is 4 times faster than zeta3.<h1 id=computing-an-order>Computing an order</h1><h2 id=bfs>BFS</h2><h2 id=layered-labels-propagation>Layered Labels Propagation</h2><h2 id=benchmarks-1>Benchmarks</h2><h1 id=references>References</h1><ul><li><a href=https://vigna.di.unimi.it/algoweb/WebGraph.pdf>https://vigna.di.unimi.it/algoweb/WebGraph.pdf</a><li><a href=https://webgraph.di.unimi.it/>https://webgraph.di.unimi.it/</a><li><a href=https://vigna.di.unimi.it/ftp/papers/Codes.pdf>https://vigna.di.unimi.it/ftp/papers/Codes.pdf</a><li><a href=https://www.ics.uci.edu/~djp3/classes/2008_01_01_INF141/Materials/p595-boldi.pdf>https://www.ics.uci.edu/~djp3/classes/2008_01_01_INF141/Materials/p595-boldi.pdf</a><li><a href=https://github.com/vigna/webgraph>https://github.com/vigna/webgraph</a><li><a href=https://github.com/vigna/webgraph-rs>https://github.com/vigna/webgraph-rs</a><li><a href=https://github.com/vigna/sux-rs>https://github.com/vigna/sux-rs</a><li><a href=https://boldi.di.unimi.it/Corsi/AlgorithmsForLargeGraphs/lesson1.pdf>https://boldi.di.unimi.it/Corsi/AlgorithmsForLargeGraphs/lesson1.pdf</a><li><a href=https://boldi.di.unimi.it/Corsi/AlgorithmsForLargeGraphs/lesson2.pdf>https://boldi.di.unimi.it/Corsi/AlgorithmsForLargeGraphs/lesson2.pdf</a><li><a href=https://boldi.di.unimi.it/Corsi/AlgorithmsForLargeGraphs/lesson3-1.pdf>https://boldi.di.unimi.it/Corsi/AlgorithmsForLargeGraphs/lesson3-1.pdf</a><li><a href=https://boldi.di.unimi.it/Corsi/AlgorithmsForLargeGraphs/lesson3-2.pdf>https://boldi.di.unimi.it/Corsi/AlgorithmsForLargeGraphs/lesson3-2.pdf</a><li><a href=https://boldi.di.unimi.it/Corsi/AlgorithmsForLargeGraphs/lesson4-1.pdf>https://boldi.di.unimi.it/Corsi/AlgorithmsForLargeGraphs/lesson4-1.pdf</a><li><a href=https://boldi.di.unimi.it/Corsi/AlgorithmsForLargeGraphs/lesson4-2.pdf>https://boldi.di.unimi.it/Corsi/AlgorithmsForLargeGraphs/lesson4-2.pdf</a></ul></section></article></main></div><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script>